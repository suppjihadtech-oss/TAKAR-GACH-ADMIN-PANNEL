<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Takar Gach Pro V24.0</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* =========================================
           1. CORE VARIABLES & RESET (HUBUHU COLORS)
           ========================================= */
        :root {
            --primary: #0CB767;
            --primary-dark: #098a4e;
            --secondary: #1e293b;
            --bg-color: #f3f6f9;
            --white: #ffffff;
            --glass: rgba(255, 255, 255, 0.95);
            --shadow-sm: 0 4px 6px rgba(0,0,0,0.02);
            --shadow-md: 0 10px 25px rgba(0,0,0,0.05);
            --gradient-header: linear-gradient(135deg, #0CB767, #059669);
            --gradient-silver: linear-gradient(135deg, #94a3b8, #64748b);
            --gradient-gold: linear-gradient(135deg, #f59e0b, #d97706);
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            outline: none;
            margin: 0;
            padding: 0;
        }

        body {
            background: var(--bg-color);
            font-family: 'Hind Siliguri', sans-serif;
            color: var(--secondary);
            padding-bottom: 90px; /* Space for bottom nav */
            user-select: none;
            overflow-x: hidden;
        }

        /* =========================================
           2. HEADER & PROFILE SECTION (SCREENSHOT 2 MATCH)
           ========================================= */
        .app-header {
            background: var(--gradient-header);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--white);
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(12, 183, 103, 0.2);
        }

        .header-title {
            font-size: 20px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Profile Card Wrapper */
        .profile-section {
            background: var(--gradient-header);
            padding-top: 70px; /* Space for fixed header */
            padding-bottom: 80px;
            border-radius: 0 0 40px 40px;
            position: relative;
            margin-bottom: 70px; /* Space for overlapping card */
        }

        /* The Float Card */
        .balance-card {
            background: var(--white);
            width: 90%;
            margin: 0 auto;
            border-radius: 30px;
            padding: 25px;
            text-align: center;
            position: absolute;
            bottom: -50px;
            left: 5%;
            box-shadow: var(--shadow-md);
            border: 1px solid rgba(0,0,0,0.03);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .u-avatar {
            width: 65px;
            height: 65px;
            background: #f0fdf4;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 28px;
            color: var(--primary);
            border: 3px solid var(--white);
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            margin-top: -55px; /* Pull up */
            margin-bottom: 10px;
        }

        .u-balance-label {
            font-size: 13px;
            font-weight: 600;
            color: #64748b;
            margin-bottom: 5px;
        }

        .u-balance-amount {
            font-size: 42px;
            font-weight: 800;
            color: var(--primary);
            line-height: 1;
            margin-bottom: 15px;
        }

        /* Dynamic Badge (Silver/Gold/Free) */
        .plan-badge {
            background: #f1f5f9;
            padding: 6px 18px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            color: #475569;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 20px;
        }
        .plan-badge.silver { background: var(--gradient-silver); color: white; box-shadow: 0 4px 10px rgba(148, 163, 184, 0.4); }
        .plan-badge.gold { background: var(--gradient-gold); color: white; box-shadow: 0 4px 10px rgba(245, 158, 11, 0.4); }

        .stats-row {
            display: flex;
            width: 100%;
            justify-content: space-between;
            border-top: 1.5px dashed #e2e8f0;
            padding-top: 15px;
        }
        .stat-item { flex: 1; text-align: center; }
        .stat-item b { display: block; font-size: 18px; color: #1e293b; }
        .stat-item small { font-size: 11px; color: #94a3b8; font-weight: 600; }

        /* =========================================
           3. 8-GRID MENU (HUBUHU ICONS)
           ========================================= */
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            padding: 0 20px;
            margin-top: 20px;
        }

        .menu-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .menu-item:active { transform: scale(0.95); }

        .menu-icon-box {
            width: 100%;
            aspect-ratio: 1/1;
            background: var(--white);
            border-radius: 22px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: var(--shadow-sm);
            border: 1px solid #f1f5f9;
            margin-bottom: 8px;
        }
        .menu-icon-box i { font-size: 24px; }
        .menu-text { font-size: 11px; font-weight: 700; color: #334155; }

        /* Icon Colors */
        .ic-vip { color: #ec4899; }
        .ic-task { color: #3b82f6; }
        .ic-cash { color: #ef4444; }
        .ic-hist { color: #f59e0b; }
        .ic-prof { color: var(--primary); }
        .ic-sup { color: #0ea5e9; }
        .ic-rule { color: #6366f1; }
        .ic-shar { color: #8b5cf6; }

        /* =========================================
           4. DAILY BONUS (TAKEN CHECK)
           ========================================= */
        .daily-card {
            background: var(--white);
            margin: 25px 20px;
            padding: 20px;
            border-radius: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-sm);
            border: 1.5px solid #ecfdf5;
            position: relative;
            overflow: hidden;
        }
        .daily-card::before {
            content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 6px; background: var(--primary);
        }
        .dc-left { display: flex; align-items: center; gap: 15px; }
        .dc-icon { 
            width: 50px; height: 50px; background: var(--primary); color: white; 
            border-radius: 15px; display: flex; justify-content: center; align-items: center; font-size: 24px;
        }
        .dc-info b { font-size: 16px; display: block; color: #1e293b; }
        .dc-info small { color: var(--primary); font-weight: 700; }

        .btn-claim {
            padding: 10px 20px;
            border-radius: 15px;
            border: none;
            font-weight: 700;
            cursor: pointer;
            font-size: 12px;
            transition: 0.3s;
        }
        .btn-claim.active { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(12, 183, 103, 0.3); }
        .btn-claim.taken { background: #e2e8f0; color: #94a3b8; cursor: not-allowed; }

        /* =========================================
           5. TASK LIST & PAYMENT (ROCKET OFF)
           ========================================= */
        .section-header {
            padding: 0 20px; margin-bottom: 15px; font-size: 17px; font-weight: 800; color: #334155;
        }

        .task-card {
            background: var(--white);
            margin: 0 20px 15px;
            padding: 18px;
            border-radius: 22px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-sm);
            border: 1px solid #f1f5f9;
        }
        .tc-icon { 
            width: 45px; height: 45px; background: #f0f9ff; color: #0ea5e9; 
            border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 20px; margin-right: 15px;
        }
        .tc-btn {
            background: var(--primary); color: white; padding: 10px 22px; 
            border-radius: 12px; border: none; font-weight: 700; cursor: pointer;
        }

        /* Payment Grid */
        .pay-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; padding: 0 20px 30px;
        }
        .pay-item {
            background: var(--white); border: 2px solid #f1f5f9; border-radius: 20px;
            padding: 20px 10px; text-align: center; cursor: pointer; position: relative;
        }
        .pay-item.active { border-color: var(--primary); background: #ecfdf5; }
        .pay-item.off { opacity: 0.6; pointer-events: none; filter: grayscale(1); }
        .off-badge {
            position: absolute; top: -8px; right: -5px; background: #ef4444; color: white;
            font-size: 9px; padding: 2px 6px; border-radius: 8px; font-weight: 800; border: 2px solid white;
        }
        .pay-img { height: 25px; margin-bottom: 8px; object-fit: contain; }
        .pay-name { font-size: 12px; font-weight: 700; display: block; }

        /* =========================================
           6. BOTTOM NAVIGATION (FIXED)
           ========================================= */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: var(--white);
            border-top: 1px solid #e2e8f0;
            display: flex; justify-content: space-around;
            padding: 12px 0; z-index: 1000;
            border-radius: 25px 25px 0 0;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.03);
        }
        .nav-item { text-align: center; color: #94a3b8; cursor: pointer; flex: 1; }
        .nav-item.active { color: var(--primary); }
        .nav-item i { font-size: 22px; margin-bottom: 4px; display: block; }
        .nav-item span { font-size: 10px; font-weight: 700; display: block; }

        /* =========================================
           7. MODALS & POPUPS
           ========================================= */
        .modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 9999;
            display: none; justify-content: center; align-items: center; padding: 20px;
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background: var(--white); width: 100%; max-width: 350px;
            padding: 30px 20px; border-radius: 35px; text-align: center; position: relative;
            animation: popUp 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        }
        @keyframes popUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .modal-close {
            position: absolute; top: 15px; right: 15px; 
            width: 35px; height: 35px; background: #f1f5f9; border-radius: 50%;
            display: flex; justify-content: center; align-items: center; cursor: pointer; color: #64748b;
        }

        .inp-field {
            width: 100%; padding: 15px; border: 2px solid #f1f5f9; border-radius: 15px;
            margin-bottom: 15px; font-family: inherit; font-weight: 600; text-align: center;
        }
        .btn-full {
            width: 100%; padding: 15px; background: var(--primary); color: white;
            border: none; border-radius: 15px; font-weight: 800; font-size: 16px; cursor: pointer;
        }

        /* PAGE SYSTEM */
        .page { display: none; padding-top: 0; }
        .page.active { display: block; animation: fadeIn 0.4s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* RECEIPT STYLES */
        .rec-icon { width: 80px; height: 80px; border-radius: 50%; margin: 0 auto 15px; display: flex; justify-content: center; align-items: center; font-size: 35px; }
        .rec-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #f8fafc; font-size: 14px; }
        .rec-row span { color: #94a3b8; font-weight: 600; }
        .rec-row b { color: #334155; font-weight: 800; }
        .rej-box { background: #fee2e2; padding: 15px; border-radius: 15px; color: #b91c1c; text-align: left; margin-top: 15px; font-size: 13px; font-weight: 600; border: 1px solid #fca5a5; }

    </style>
</head>
<body>

    <div class="app-header">
        <div class="header-title"><i class="fas fa-leaf"></i> টাকার গাছ</div>
        <div onclick="location.reload()"><i class="fas fa-sync-alt"></i></div>
    </div>

    <div id="page-home" class="page active">
        
        <div class="profile-section">
            <div class="balance-card">
                <div class="u-avatar"><i class="fas fa-user"></i></div>
                <div class="u-balance-label">মোট ব্যালেন্স</div>
                <div class="u-balance-amount">৳ <span id="u-bal">0</span></div>
                <div id="u-badge" class="plan-badge">ফ্রি মেম্বার</div>
                
                <div class="stats-row">
                    <div class="stat-item"><b id="u-ref-cnt">0</b><small>রেফার সংখ্যা</small></div>
                    <div class="stat-item"><b>৳ <span id="u-ref-inc">0</span></b><small>রেফার কমিশন</small></div>
                </div>
            </div>
        </div>

        <div class="menu-grid">
            <div class="menu-item" onclick="nav('vip')"><div class="menu-icon-box"><i class="fas fa-crown ic-vip"></i></div><span class="menu-text">ভিআইপি</span></div>
            <div class="menu-item" onclick="nav('tasks')"><div class="menu-icon-box"><i class="fas fa-tasks ic-task"></i></div><span class="menu-text">কাজ</span></div>
            <div class="menu-item" onclick="nav('withdraw')"><div class="menu-icon-box"><i class="fas fa-wallet ic-cash"></i></div><span class="menu-text">ক্যাশআউট</span></div>
            <div class="menu-item" onclick="nav('history')"><div class="menu-icon-box"><i class="fas fa-history ic-hist"></i></div><span class="menu-text">হিস্টরি</span></div>
            <div class="menu-item" onclick="nav('profile')"><div class="menu-icon-box"><i class="fas fa-user ic-prof"></i></div><span class="menu-text">প্রোফাইল</span></div>
            <div class="menu-item" onclick="window.open('https://t.me/TAKAR_GACH_SUPPORT')"><div class="menu-icon-box"><i class="fab fa-telegram ic-sup"></i></div><span class="menu-text">সাপোর্ট</span></div>
            <div class="menu-item" onclick="showRules()"><div class="menu-icon-box"><i class="fas fa-scroll ic-rule"></i></div><span class="menu-text">নিয়মাবলী</span></div>
            <div class="menu-item" onclick="shareApp()"><div class="menu-icon-box"><i class="fas fa-share-alt ic-shar"></i></div><span class="menu-text">শেয়ার</span></div>
        </div>

        <div class="daily-card">
            <div class="dc-left">
                <div class="dc-icon"><i class="fas fa-gift"></i></div>
                <div class="dc-info"><b>ডেইলি বোনাস</b><small>+ ৳২ ফ্রি</small></div>
            </div>
            <button id="bonus-btn" class="btn-claim active" onclick="claimBonus()">CLAIM</button>
        </div>

        <div class="section-header">আপনার জন্য কাজ</div>
        <div id="home-task-list">
            </div>

        <div style="height: 100px;"></div>
    </div>

    <div id="page-withdraw" class="page" style="padding-top:80px">
        <div class="section-header">পেমেন্ট গেটওয়ে</div>
        <div class="daily-card" style="display:block; text-align:center;">
            <p style="color:#64748b; margin-bottom:10px;">বর্তমান ব্যালেন্স</p>
            <h1 style="color:var(--primary); margin-bottom:20px;">৳ <span id="w-bal">0</span></h1>
            
            <div class="pay-grid">
                <div class="pay-item" id="pay-bkash" onclick="selPay('Bkash')">
                    <img src="https://freelogopng.com/images/all_img/1656227518bkash-logo-png.png" class="pay-img">
                    <span class="pay-name">বিকাশ</span>
                </div>
                <div class="pay-item" id="pay-nagad" onclick="selPay('Nagad')">
                    <img src="https://freelogopng.com/images/all_img/1679248787nagad-logo.png" class="pay-img">
                    <span class="pay-name">নগদ</span>
                </div>
                <div class="pay-item off">
                    <img src="https://seeklogo.com/images/D/dutch-bangla-rocket-logo-B4D1CC458D-seeklogo.com.png" class="pay-img">
                    <span class="pay-name">রকেট</span>
                    <span class="off-badge">OFF</span>
                </div>
            </div>

            <input id="w-amount" type="number" class="inp-field" placeholder="পরিমাণ (৳)">
            <input id="w-number" type="number" class="inp-field" placeholder="রিসিভ নাম্বার">
            <button class="btn-full" onclick="submitWithdraw()">রিকোয়েস্ট পাঠান</button>
        </div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="nav('home')"><i class="fas fa-home"></i><span>হোম</span></div>
        <div class="nav-item" onclick="nav('tasks')"><i class="fas fa-list-check"></i><span>কাজ</span></div>
        <div class="nav-item" onclick="nav('history')"><i class="fas fa-file-invoice"></i><span>হিস্টরি</span></div>
        <div class="nav-item" onclick="nav('profile')"><i class="fas fa-user-circle"></i><span>প্রোফাইল</span></div>
    </div>

    <div id="notice-modal" class="modal">
        <div class="modal-content">
            <div class="modal-close" onclick="closeModal('notice-modal')"><i class="fas fa-times"></i></div>
            <div style="font-size:50px; color:#f59e0b; margin-bottom:15px"><i class="fas fa-bell"></i></div>
            <h3 id="nt-title">নোটিশ</h3>
            <p id="nt-msg" style="color:#64748b; margin:15px 0; line-height:1.5;">...</p>
            <button class="btn-full" onclick="closeModal('notice-modal')">বুঝতে পেরেছি</button>
        </div>
    </div>

    <div id="rec-modal" class="modal">
        <div class="modal-content">
            <div class="modal-close" onclick="closeModal('rec-modal')"><i class="fas fa-times"></i></div>
            <div id="rec-body"></div>
        </div>
    </div>

    <script>
        // =========================================
        // 1. FIREBASE CONFIGURATION & VARS
        // =========================================
        const firebaseConfig = { 
            apiKey: "AIzaSyDgI-d8iwWr40tmknbY6jhH0oRb2Tvg4d0", 
            authDomain: "takar-gach-a1d84.firebaseapp.com", 
            databaseURL: "https://takar-gach-a1d84-default-rtdb.firebaseio.com", 
            projectId: "takar-gach-a1d84", 
            storageBucket: "takar-gach-a1d84.firebasestorage.app", 
            messagingSenderId: "637802367074", 
            appId: "1:637802367074:web:2e7f6c0670ec47f3a1693b" 
        };
        
        // Initialize Firebase
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        // Global Variables
        let UID = localStorage.getItem('tg_uid'); // Get saved UID
        let USER_DATA = {};
        let SEL_METHOD = '';

        // =========================================
        // 2. AUTH & INITIALIZATION
        // =========================================
        window.onload = () => {
            // Check Login (Simple simulation for demo, replace with real auth if needed)
            if(!UID) {
                // If no user, redirect to login or create a temp ID
                // For this demo, let's assume user is logged in or create a demo ID
                // window.location.href = "login.html"; 
                // Demo purpose only:
                console.log("No User Found, waiting for login...");
            } else {
                initApp();
            }
        };

        function initApp() {
            // 1. Listen to User Data
            db.ref('users/' + UID).on('value', snapshot => {
                USER_DATA = snapshot.val();
                if (!USER_DATA) return; // Handle new user case

                // Update Balance
                document.getElementById('u-bal').innerText = USER_DATA.balance || 0;
                document.getElementById('w-bal').innerText = USER_DATA.balance || 0;
                
                // Update Stats
                document.getElementById('u-ref-cnt').innerText = USER_DATA.refCount || 0;
                document.getElementById('u-ref-inc').innerText = USER_DATA.refEarn || 0;

                // Update Membership Badge (The Silver Fix)
                const plan = USER_DATA.currentPlan || 'Free';
                const badge = document.getElementById('u-badge');
                
                if (plan.toLowerCase().includes('silver') || plan.includes('সিলভার')) {
                    badge.className = 'plan-badge silver';
                    badge.innerHTML = '<i class="fas fa-crown"></i> সিলভার Member';
                } else if (plan.toLowerCase().includes('gold') || plan.includes('গোল্ড')) {
                    badge.className = 'plan-badge gold';
                    badge.innerHTML = '<i class="fas fa-crown"></i> গোল্ড Member';
                } else {
                    badge.className = 'plan-badge';
                    badge.innerHTML = 'ফ্রি মেম্বার';
                }

                // Check Daily Bonus
                checkDailyBonusState();
            });

            // 2. Load Tasks
            loadTasks();

            // 3. Check for Admin Notice
            db.ref('settings/notice').once('value', s => {
                const notice = s.val();
                if(notice && notice.message) {
                    document.getElementById('nt-title').innerText = notice.title || 'নোটিশ';
                    document.getElementById('nt-msg').innerText = notice.message;
                    document.getElementById('notice-modal').style.display = 'flex';
                }
            });
        }

        // =========================================
        // 3. DAILY BONUS LOGIC (TAKEN CHECK)
        // =========================================
        function checkDailyBonusState() {
            const btn = document.getElementById('bonus-btn');
            const today = new Date().toDateString();
            
            if (USER_DATA.lastBonus === today) {
                btn.innerText = 'নিয়েছেন ✅';
                btn.classList.remove('active');
                btn.classList.add('taken');
                btn.disabled = true;
            } else {
                btn.innerText = 'CLAIM';
                btn.classList.add('active');
                btn.classList.remove('taken');
                btn.disabled = false;
            }
        }

        function claimBonus() {
            const today = new Date().toDateString();
            if (USER_DATA.lastBonus === today) return;

            // Give 2 Taka Bonus
            const newBal = (parseInt(USER_DATA.balance) || 0) + 2;
            
            db.ref('users/' + UID).update({
                balance: newBal,
                lastBonus: today
            }).then(() => {
                Swal.fire({
                    icon: 'success',
                    title: 'অভিনন্দন!',
                    text: 'আপনি ৳২ ডেইলি বোনাস পেয়েছেন।',
                    confirmButtonColor: '#0CB767'
                });
            });
        }

        // =========================================
        // 4. TASK SYSTEM (DYNAMIC LIST)
        // =========================================
        function loadTasks() {
            db.ref('settings/tasks').on('value', snapshot => {
                const tasks = snapshot.val() || {};
                const container = document.getElementById('home-task-list');
                const taskPageList = document.getElementById('task-page-list'); // If exists
                container.innerHTML = '';

                Object.keys(tasks).forEach(key => {
                    const t = tasks[key];
                    // Check if already completed
                    const isDone = USER_DATA.comp && USER_DATA.comp[key];
                    
                    // Render Logic
                    if(!isDone) {
                        const html = `
                        <div class="task-card">
                            <div class="t-left">
                                <div class="tc-icon"><i class="fab fa-telegram-plane"></i></div>
                                <div>
                                    <b style="font-size:15px; color:#334155">${t.title}</b>
                                    <small style="display:block; color:#0CB767; font-weight:700; margin-top:3px">+ ৳${t.reward}</small>
                                </div>
                            </div>
                            <button class="tc-btn" onclick="doTask('${key}', '${t.link}', ${t.reward})">START</button>
                        </div>`;
                        container.innerHTML += html;
                    }
                });
                
                if(container.innerHTML === '') {
                    container.innerHTML = '<p style="text-align:center; padding:20px; color:#94a3b8; font-weight:600">বর্তমানে কোনো কাজ নেই</p>';
                }
            });
        }

        function doTask(taskId, link, reward) {
            window.open(link, '_blank');
            
            // Simulate Wait Time
            setTimeout(() => {
                Swal.fire({
                    title: 'প্রমাণ জমা দিন',
                    text: 'আপনার টেলিগ্রাম ইউজারনেম বা স্ক্রিনশট লিংক দিন',
                    input: 'text',
                    showCancelButton: true,
                    confirmButtonText: 'জমা দিন',
                    confirmButtonColor: '#0CB767',
                    cancelButtonText: 'বাতিল'
                }).then((result) => {
                    if (result.isConfirmed && result.value) {
                        // Save to History as Pending
                        db.ref('users/' + UID + '/history').push({
                            type: 'Task Reward',
                            amount: reward,
                            status: 'Pending',
                            date: new Date().toLocaleString(),
                            proof: result.value,
                            taskId: taskId
                        });
                        
                        // Mark locally as pending/done to hide
                        db.ref('users/' + UID + '/comp/' + taskId).set(true);

                        Swal.fire('সফল!', 'আপনার কাজটি জমা দেওয়া হয়েছে। এডমিন চেক করে ব্যালেন্স যুক্ত করবেন।', 'success');
                    }
                });
            }, 5000); // 5 seconds delay
        }

        // =========================================
        // 5. WITHDRAW SYSTEM (SELECTOR & LOGIC)
        // =========================================
        function selPay(method) {
            SEL_METHOD = method;
            
            // UI Update
            document.querySelectorAll('.pay-item').forEach(el => el.classList.remove('active'));
            if(method === 'Bkash') document.getElementById('pay-bkash').classList.add('active');
            if(method === 'Nagad') document.getElementById('pay-nagad').classList.add('active');
        }

        function submitWithdraw() {
            const amt = document.getElementById('w-amount').value;
            const num = document.getElementById('w-number').value;

            if (!SEL_METHOD) return Swal.fire('Error', 'পেমেন্ট মেথড সিলেক্ট করুন', 'warning');
            if (!amt || !num) return Swal.fire('Error', 'সব তথ্য পূরণ করুন', 'warning');
            if (parseInt(amt) < 20) return Swal.fire('Error', 'নূন্যতম উইথড্র ২০ টাকা', 'warning');
            if (parseInt(amt) > parseInt(USER_DATA.balance)) return Swal.fire('Error', 'পর্যাপ্ত ব্যালেন্স নেই', 'error');

            // Deduct Balance Immediately
            const newBal = parseInt(USER_DATA.balance) - parseInt(amt);
            db.ref('users/' + UID).update({ balance: newBal });

            // Push Request
            db.ref('users/' + UID + '/history').push({
                type: 'Withdraw',
                method: SEL_METHOD,
                amount: amt,
                number: num,
                status: 'Pending',
                date: new Date().toLocaleString()
            });

            Swal.fire({
                icon: 'success',
                title: 'সফল!',
                text: 'উইথড্র রিকোয়েস্ট পাঠানো হয়েছে।',
                confirmButtonColor: '#0CB767'
            });
            
            // Clear inputs
            document.getElementById('w-amount').value = '';
            document.getElementById('w-number').value = '';
        }

        // =========================================
        // 6. HISTORY & RECEIPT (SCREENSHOT MATCH)
        // =========================================
        function renderHistory() {
            // This function is called when nav('history') is clicked
            // But since History is in the same page or modal, we can render it dynamically
            // For this layout, let's assume we show it in a modal or separate div
            // Here is the RECEIPT VIEWER Logic
        }

        // Helper to view receipt from history list (Add this to your history render loop)
        function openReceipt(h) {
            let isRej = h.status === 'Rejected';
            let isSuc = h.status === 'Success';
            
            let icon = isRej ? 'times' : (isSuc ? 'check' : 'clock');
            let color = isRej ? '#ef4444' : (isSuc ? '#0CB767' : '#f59e0b');
            let bg = isRej ? '#fee2e2' : (isSuc ? '#d1fae5' : '#fef3c7');

            const html = `
                <div class="rec-icon" style="background:${bg}; color:${color}">
                    <i class="fas fa-${icon}"></i>
                </div>
                <h2 style="margin:0 0 5px; color:${color}; font-weight:800">${h.status}</h2>
                <small style="color:#94a3b8; font-weight:600">ID: ${h.trxId || 'TXN-'+Math.floor(Math.random()*10000)}</small>
                
                <div style="border-bottom: 2px dashed #e2e8f0; margin: 25px 0;"></div>
                
                <div class="rec-row"><span>লেনদেনের ধরন</span><b>${h.type}</b></div>
                <div class="rec-row"><span>মেথড</span><b>${h.method || 'System'}</b></div>
                <div class="rec-row"><span>পরিমাণ</span><b style="font-size:18px; color:${color}">৳${h.amount}</b></div>
                <div class="rec-row"><span>তারিখ</span><b>${h.date.split(',')[0]}</b></div>
                
                ${isRej ? `<div class="rej-box"><i class="fas fa-exclamation-circle"></i> <b>বাতিলের কারণ:</b><br>${h.reason || 'নিয়ম ভঙ্গ করেছেন'}</div>` : ''}
                
                <button onclick="closeModal('rec-modal')" style="width:100%; padding:15px; background:#f1f5f9; color:#64748b; border:none; border-radius:15px; font-weight:800; margin-top:25px; cursor:pointer;">CLOSE WINDOW</button>
            `;
            
            document.getElementById('rec-body').innerHTML = html;
            document.getElementById('rec-modal').style.display = 'flex';
        }

        // =========================================
        // 7. NAVIGATION SYSTEM
        // =========================================
        function nav(page) {
            // Remove active from all pages
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            // Remove active from all nav items
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

            // Activate specific page
            if (page === 'home') {
                document.getElementById('page-home').classList.add('active');
                document.querySelectorAll('.nav-item')[0].classList.add('active');
            } else if (page === 'withdraw') {
                document.getElementById('page-withdraw').classList.add('active');
                // Highlight bottom nav logic if needed
            } else if (page === 'tasks') {
                // Show tasks page (You can duplicate page structure for tasks)
                document.querySelectorAll('.nav-item')[1].classList.add('active');
                Swal.fire('Loading...', 'টাস্ক পেজ লোড হচ্ছে', 'info');
            } else if (page === 'history') {
                // Fetch and show history
                showHistoryModal(); // Custom function to show history list
                document.querySelectorAll('.nav-item')[2].classList.add('active');
            } else if (page === 'profile') {
                // Scroll to top or show profile modal
                document.querySelectorAll('.nav-item')[3].classList.add('active');
                window.scrollTo(0,0);
            }
        }

        // Helper for History List (Since we didn't make a full page for it yet)
        function showHistoryModal() {
            let listHtml = '<div style="max-height:300px; overflow-y:auto;">';
            if (USER_DATA.history) {
                const histArr = Object.values(USER_DATA.history).reverse();
                histArr.forEach(h => {
                    listHtml += `
                    <div onclick='openReceipt(${JSON.stringify(h)})' style="display:flex; justify-content:space-between; padding:15px; border-bottom:1px solid #eee; cursor:pointer">
                        <div>
                            <b style="font-size:14px; color:#333">${h.type}</b>
                            <small style="display:block; color:#999">${h.date.split(',')[0]}</small>
                        </div>
                        <div style="text-align:right">
                            <b style="color:${h.status==='Success'?'#0CB767':(h.status==='Rejected'?'#ef4444':'#f59e0b')}">৳${h.amount}</b>
                            <small style="display:block; font-weight:700; font-size:10px; color:#94a3b8">${h.status}</small>
                        </div>
                    </div>`;
                });
            } else {
                listHtml += '<p style="text-align:center; padding:20px; color:#999">কোনো লেনদেন নেই</p>';
            }
            listHtml += '</div>';

            Swal.fire({
                title: 'লেনদেন হিস্টরি',
                html: listHtml,
                showConfirmButton: false,
                showCloseButton: true
            });
        }

        // Helpers
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function shareApp() { 
            const link = `https://t.me/Takar_Gaach_Bot?start=${UID}`;
            navigator.clipboard.writeText(link);
            Swal.fire('কপি হয়েছে!', 'রেফার লিংক কপি হয়েছে। বন্ধুদের সাথে শেয়ার করুন।', 'success');
        }
        function showRules() {
            Swal.fire({
                title: 'নিয়মাবলী',
                html: '<ul style="text-align:left; font-size:14px; color:#555"><li>প্রতিদিন ১ বার ডেইলি বোনাস নেওয়া যাবে।</li><li>সঠিকভাবে টাস্ক না করলে পেমেন্ট পাবেন না।</li><li>২০ টাকা হলে উইথড্র দেওয়া যাবে।</li></ul>',
                confirmButtonColor: '#0CB767'
            });
        }

    </script>
</body>
</html>
