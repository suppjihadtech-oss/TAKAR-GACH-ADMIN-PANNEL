<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Takar Gach - Mobile Admin V25.0</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* =========================================
           1. PREMIUM MOBILE UI & DESIGN
           ========================================= */
        :root {
            --primary-grad: linear-gradient(135deg, #1e293b, #0f172a);
            --accent-grad: linear-gradient(135deg, #059669, #10b981);
            --glass: rgba(255, 255, 255, 0.95);
            --primary: #059669;
            --bg: #f3f6f9;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { margin: 0; background: var(--bg); font-family: 'Hind Siliguri', sans-serif; padding-bottom: 50px; }

        /* HEADER & DASHBOARD STATS */
        .header { background: var(--primary-grad); padding: 40px 20px 120px; border-radius: 0 0 50px 50px; color: white; text-align: center; position: relative; }
        .header h2 { margin: 0; font-size: 24px; font-weight: 800; color: #10b981; }
        
        .stats-card { background: var(--glass); backdrop-filter: blur(20px); width: 90%; margin: 0 auto; padding: 25px; border-radius: 35px; position: absolute; bottom: -60px; left: 0; right: 0; box-shadow: 0 15px 35px rgba(0,0,0,0.1); border: 1px solid white; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .stat-item { text-align: center; }
        .stat-item h3 { margin: 0; font-size: 20px; color: #333; }
        .stat-item small { color: #888; font-weight: 700; font-size: 11px; display: block; }

        /* 8-GRID MENU (USER PANEL STYLE) */
        .admin-grid { margin-top: 90px; padding: 0 18px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
        .m-item { background: white; padding: 18px 5px; border-radius: 22px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.03); cursor: pointer; border: 1.5px solid #f3f4f6; transition: 0.2s; }
        .m-item:active { transform: scale(0.92); border-color: var(--primary); background: #ecfdf5; }
        .m-item i { font-size: 26px; margin-bottom: 8px; display: block; }
        .m-item span { font-size: 10px; font-weight: 800; color: #444; line-height: 1.2; display: block; }

        /* SECTIONS & TABLES */
        .section { display: none; padding: 30px 18px; animation: fadeInUp 0.4s ease-out; }
        .section.active { display: block; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .card { background: white; padding: 20px; border-radius: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.02); border: 1px solid #f3f4f6; margin-bottom: 20px; }
        .card h3 { margin-top: 0; font-size: 18px; border-bottom: 1.5px solid #f3f4f6; padding-bottom: 10px; }

        /* MOBILE RESPONSIVE TABLES */
        .table-container { width: 100%; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 450px; }
        th { text-align: left; padding: 12px; background: #f8fafc; color: #666; font-size: 13px; border-bottom: 2px solid #eee; }
        td { padding: 12px; border-bottom: 1px solid #eee; font-size: 14px; color: #333; }

        /* BUTTONS & INPUTS */
        .btn { padding: 8px 15px; border-radius: 12px; border: none; cursor: pointer; font-weight: 700; font-size: 12px; transition: 0.3s; font-family: inherit; }
        .btn-suc { background: #d1fae5; color: #059669; }
        .btn-rej { background: #fee2e2; color: #ef4444; }
        .btn-main { background: var(--accent-grad); color: white; padding: 15px; width: 100%; font-size: 16px; margin-top: 10px; border-radius: 15px; }

        .inp { width: 100%; padding: 14px; border: 1.5px solid #eee; border-radius: 15px; margin-bottom: 12px; font-size: 14px; font-family: inherit; }
        
        .badge { padding: 4px 10px; border-radius: 10px; font-size: 10px; font-weight: 800; }
        .badge-vip { background: #fef3c7; color: #d97706; }
        .badge-free { background: #f3f4f6; color: #666; }

        /* FLOATING BACK BUTTON */
        .back-btn { position: fixed; top: 15px; left: 15px; z-index: 1000; background: rgba(255,255,255,0.2); color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; display: none; }
    </style>
</head>
<body>

    <div id="back-nav" class="back-btn" onclick="showDashboard()"><i class="fas fa-arrow-left"></i></div>

    <div id="admin-home">
        <div class="header">
            <h2>TAKAR GACH ADMIN V25.0</h2>
            <small style="color:#10b981;font-weight:700">MASTER CONTROL PANEL</small>
            <div class="stats-card">
                <div class="stat-item"><b><span id="st-users">0</span></b><small>মোট ইউজার</small></div>
                <div class="stat-item"><b>৳ <span id="st-bal">0</span></b><small>মোট ব্যালেন্স</small></div>
                <div class="stat-item"><b><span id="st-req">0</span></b><small>পেন্ডিং রিকোয়েস্ট</small></div>
                <div class="stat-item"><b>৳ <span id="st-today">0</span></b><small>আজকের ডিপোজিট</small></div>
            </div>
        </div>

        <div class="admin-grid">
            <div class="m-item" onclick="openSec('req')"><i class="fas fa-bell" style="color:#ef4444"></i><span>পেন্ডিং</span></div>
            <div class="m-item" onclick="openSec('tasks')"><i class="fas fa-tasks" style="color:#3b82f6"></i><span>টাস্ক সেটিংস</span></div>
            <div class="m-item" onclick="openSec('users')"><i class="fas fa-users" style="color:#10b981"></i><span>ইউজার লিস্ট</span></div>
            <div class="m-item" onclick="openSec('vip')"><i class="fas fa-crown" style="color:#f59e0b"></i><span>VIP রিকোয়েস্ট</span></div>
            <div class="m-item" onclick="openSec('config')"><i class="fas fa-cog" style="color:#6366f1"></i><span>সেটিংস</span></div>
            <div class="m-item" onclick="openSec('notice')"><i class="fas fa-bullhorn" style="color:#ec4899"></i><span>নোটিশ</span></div>
            <div class="m-item" onclick="window.open('https://t.me/TAKAR_GACH_ADMIN')"><i class="fab fa-telegram" style="color:#229ed9"></i><span>সাপোর্ট</span></div>
            <div class="m-item" onclick="location.reload()"><i class="fas fa-sync" style="color:#6b7280"></i><span>রিফ্রেশ</span></div>
        </div>
    </div>

    <div id="sec-req" class="section">
        <div class="card">
            <h3>টাস্ক প্রুফ ও উইথড্র রিকোয়েস্ট</h3>
            <div class="table-container">
                <table id="req-table">
                    <thead><tr><th>ইউজার</th><th>ধরন</th><th>পরিমাণ</th><th>অ্যাকশন</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="sec-tasks" class="section">
        <div class="card">
            <h3>নতুন টাস্ক যোগ করুন</h3>
            <input id="t-title" class="inp" placeholder="টাস্ক নাম (উদা: চ্যানেল জয়েন)">
            <input id="t-link" class="inp" placeholder="লিংক (https://...)">
            <input id="t-reward" type="number" class="inp" placeholder="রিওয়ার্ড (৳)">
            <select id="t-target" class="inp">
                <option value="Free">Free Member</option>
                <option value="Silver">Silver Member</option>
                <option value="Gold">Gold Member</option>
            </select>
            <button class="btn-main" onclick="saveTask()">সেভ করুন</button>
        </div>
        <div class="card">
            <h3>বর্তমান টাস্কসমূহ</h3>
            <div id="tasks-list"></div>
        </div>
    </div>

    <div id="sec-users" class="section">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0">ইউজার ম্যানেজমেন্ট</h3>
                <input id="user-search" class="inp" style="width:150px; margin-bottom:0; padding:8px;" placeholder="খুঁজুন...">
            </div>
            <div class="table-container">
                <table id="user-table">
                    <thead><tr><th>নাম ও ফোন</th><th>ব্যালেন্স</th><th>অ্যাকশন</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="sec-config" class="section">
        <div class="card">
            <h3>গেটওয়ে সেটিংস</h3>
            <label><small>বিকাশ নাম্বার</small></label>
            <input id="c-bkash" class="inp">
            <label><small>নগদ নাম্বার</small></label>
            <input id="c-nagad" class="inp">
            <label><small>রকেট নাম্বার</small></label>
            <input id="c-rocket" class="inp">
            <hr>
            <label><small>টেলিগ্রাম বোট টোকেন</small></label>
            <input id="c-token" class="inp">
            <button class="btn-main" onclick="updateConfig()">সব আপডেট করুন</button>
        </div>
    </div>
    <script>
        // =========================================
        // 1. FIREBASE CONFIGURATION (Must match User Panel V24.0)
        // =========================================
        const firebaseConfig = { 
            apiKey: "AIzaSyDgI-d8iwWr40tmknbY6jhH0oRb2Tvg4d0", 
            authDomain: "takar-gach-a1d84.firebaseapp.com", 
            databaseURL: "https://takar-gach-a1d84-default-rtdb.firebaseio.com", 
            projectId: "takar-gach-a1d84", 
            storageBucket: "takar-gach-a1d84.firebasestorage.app", 
            messagingSenderId: "637802367074", 
            appId: "1:637802367074:web:2e7f6c0670ec47f3a1693b" 
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // GLOBAL DATA
        let ALL_USERS = {}, ALL_TASKS = {}, PENDING_REQS = [];

        // =========================================
        // 2. INITIALIZATION & DATA SYNC
        // =========================================
        window.onload = () => {
            initAdmin();
        };

        function initAdmin() {
            // Listen for Users & Stats
            db.ref('users').on('value', snapshot => {
                ALL_USERS = snapshot.val() || {};
                processDashboard();
                renderUserList();
            });

            // Listen for Settings
            db.ref('settings').on('value', snapshot => {
                const data = snapshot.val() || {};
                ALL_TASKS = data.tasks || {};
                const config = data.config || {};
                
                // Pre-fill Config
                document.getElementById('c-bkash').value = config.bkash || '';
                document.getElementById('c-nagad').value = config.nagad || '';
                document.getElementById('c-rocket').value = config.rocket || '';
                document.getElementById('c-token').value = config.botToken || '';
                
                renderTasks();
            });
        }

        // =========================================
        // 3. DASHBOARD PROCESSING
        // =========================================
        function processDashboard() {
            let totalUsers = 0, totalBal = 0, pending = 0;
            PENDING_REQS = [];

            Object.keys(ALL_USERS).forEach(uid => {
                const u = ALL_USERS[uid];
                totalUsers++;
                totalBal += (parseInt(u.balance) || 0);

                if (u.history) {
                    Object.keys(u.history).forEach(hid => {
                        const h = u.history[hid];
                        if (h.status === 'Pending') {
                            PENDING_REQS.push({ ...h, uid, hid, userName: u.name });
                            pending++;
                        }
                    });
                }
            });

            document.getElementById('st-users').innerText = totalUsers;
            document.getElementById('st-bal').innerText = totalBal;
            document.getElementById('st-req').innerText = pending;
            
            renderRequests();
        }

        // =========================================
        // 4. REQUESTS MANAGEMENT (Task, VIP, Withdraw)
        // =========================================
        function renderRequests() {
            const tbody = document.querySelector('#req-table tbody');
            tbody.innerHTML = '';
            PENDING_REQS.forEach(r => {
                tbody.innerHTML += `
                    <tr>
                        <td><b>${r.userName}</b><br><small>${r.uid}</small></td>
                        <td><span class="badge badge-vip">${r.type}</span></td>
                        <td>৳${r.amount}</td>
                        <td>
                            <button class="btn btn-suc" onclick="manageReq('${r.uid}', '${r.hid}', 'approve', '${r.type}', ${r.amount})">অ্যাপ্রুভ</button>
                            <button class="btn btn-rej" onclick="manageReq('${r.uid}', '${r.hid}', 'reject')">বাতিল</button>
                        </td>
                    </tr>`;
            });
        }

        async function manageReq(uid, hid, action, type, amt) {
            if (action === 'approve') {
                const updates = {};
                updates[`users/${uid}/history/${hid}/status`] = 'Success';

                // Balance Logic for Tasks/Rewards
                if (type.includes('Task') || type.includes('Reward')) {
                    const currentBal = (parseInt(ALL_USERS[uid].balance) || 0);
                    updates[`users/${uid}/balance`] = currentBal + parseInt(amt);
                }

                // VIP Membership Logic
                if (type.includes('Buy')) {
                    const plan = type.replace('Buy ', '');
                    updates[`users/${uid}/isVip`] = true;
                    updates[`users/${uid}/currentPlan`] = plan + " Member";
                }

                await db.ref().update(updates);
                Swal.fire('সফল!', 'রিকোয়েস্টটি সফলভাবে অ্যাপ্রুভ হয়েছে।', 'success');
            } else {
                // Reject with Reason
                const { value: reason } = await Swal.fire({
                    title: 'বাতিলের কারণ লিখুন',
                    input: 'text',
                    inputPlaceholder: 'উদা: সঠিক নিয়ম মানা হয়নি',
                    showCancelButton: true,
                    confirmButtonText: 'নিশ্চিত করুন'
                });

                if (reason) {
                    await db.ref(`users/${uid}/history/${hid}`).update({
                        status: 'Rejected',
                        reason: reason
                    });
                    Swal.fire('বাতিল!', 'রিকোয়েস্টটি রিজেক্ট করা হয়েছে।', 'error');
                }
            }
        }

        // =========================================
        // 5. USER & TASK MANAGEMENT
        // =========================================
        function renderUserList() {
            const tbody = document.querySelector('#user-table tbody');
            const search = document.getElementById('user-search').value.toLowerCase();
            tbody.innerHTML = '';

            Object.keys(ALL_USERS).forEach(uid => {
                const u = ALL_USERS[uid];
                if (u.name.toLowerCase().includes(search) || uid.includes(search)) {
                    tbody.innerHTML += `
                        <tr>
                            <td><b>${u.name}</b><br><small>${uid}</small></td>
                            <td>৳${u.balance}<br><span class="badge badge-free">${u.currentPlan || 'ফ্রি'}</span></td>
                            <td><button class="btn btn-suc" onclick="editUser('${uid}')">Edit</button></td>
                        </tr>`;
                }
            });
        }

        async function editUser(uid) {
            const u = ALL_USERS[uid];
            const { value: formValues } = await Swal.fire({
                title: 'ইউজার ডাটা এডিট',
                html:
                    `<label>ব্যালেন্স</label><input id="sw-bal" class="swal2-input" value="${u.balance}">` +
                    `<label>প্যাকেজ (Silver/Gold/Free)</label><input id="sw-plan" class="swal2-input" value="${u.currentPlan || 'Free Member'}">`,
                focusConfirm: false,
                preConfirm: () => [
                    document.getElementById('sw-bal').value,
                    document.getElementById('sw-plan').value
                ]
            });

            if (formValues) {
                db.ref('users/' + uid).update({
                    balance: parseInt(formValues[0]),
                    currentPlan: formValues[1],
                    isVip: formValues[1] !== 'Free Member'
                });
                Swal.fire('সফল', 'ইউজার ডাটা আপডেট হয়েছে।', 'success');
            }
        }

        function saveTask() {
            const title = document.getElementById('t-title').value;
            const link = document.getElementById('t-link').value;
            const reward = document.getElementById('t-reward').value;
            const target = document.getElementById('t-target').value;

            if (!title || !link || !reward) return Swal.fire('Error', 'সব তথ্য দিন', 'warning');

            const tid = 'task_' + Date.now();
            db.ref('settings/tasks/' + tid).set({ title, link, reward: parseInt(reward), target });
            Swal.fire('সফল', 'নতুন টাস্ক যোগ হয়েছে।', 'success');
            // Clear fields
            document.getElementById('t-title').value = '';
            document.getElementById('t-link').value = '';
            document.getElementById('t-reward').value = '';
        }

        function renderTasks() {
            const list = document.getElementById('tasks-list');
            list.innerHTML = '';
            Object.keys(ALL_TASKS).forEach(tid => {
                const t = ALL_TASKS[tid];
                list.innerHTML += `
                    <div style="display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom:1px solid #eee;">
                        <div><b>${t.title}</b><br><small>${t.target} | ৳${t.reward}</small></div>
                        <button class="btn btn-rej" onclick="db.ref('settings/tasks/${tid}').remove()">মুছুন</button>
                    </div>`;
            });
        }

        function updateConfig() {
            const bk = document.getElementById('c-bkash').value;
            const ng = document.getElementById('c-nagad').value;
            const rk = document.getElementById('c-rocket').value;
            const tk = document.getElementById('c-token').value;

            db.ref('settings/config').update({ 
                bkash: bk, 
                nagad: ng, 
                rocket: rk,
                botToken: tk
            });
            Swal.fire('সফল', 'অ্যাপ কনফিগারেশন আপডেট হয়েছে।', 'success');
        }

        // =========================================
        // 6. UI HELPERS
        // =========================================
        function openSec(id) {
            document.getElementById('admin-home').style.display = 'none';
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById('sec-' + id).classList.add('active');
            document.getElementById('back-nav').style.display = 'flex';
        }

        function showDashboard() {
            document.getElementById('admin-home').style.display = 'block';
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById('back-nav').style.display = 'none';
        }
    </script>
</body>
</html>
