<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Takar Gach - Master Admin V</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --admin-bg: #f0f2f5;
            --sidebar-color: #1c1e21;
            --primary: #059669;
            --accent: #10b981;
        }

        body { margin: 0; font-family: 'Hind Siliguri', sans-serif; background: var(--admin-bg); display: flex; }
        
        /* SIDEBAR */
        .sidebar { width: 260px; height: 100vh; background: var(--sidebar-color); color: white; position: fixed; padding: 20px; box-sizing: border-box; }
        .sidebar h2 { color: var(--accent); border-bottom: 1px solid #333; padding-bottom: 15px; margin-top: 0; }
        .nav-link { display: flex; align-items: center; gap: 12px; padding: 15px; color: #ccc; cursor: pointer; border-radius: 10px; transition: 0.3s; margin-bottom: 5px; }
        .nav-link:hover, .nav-link.active { background: #333; color: white; }
        .nav-link i { font-size: 20px; width: 25px; }

        /* MAIN CONTENT */
        .main-content { margin-left: 260px; width: calc(100% - 260px); padding: 30px; box-sizing: border-box; }
        
        /* STATS CARDS */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-left: 5px solid var(--primary); }
        .stat-card h4 { margin: 0; color: #666; font-size: 14px; }
        .stat-card h2 { margin: 10px 0 0; color: #333; font-size: 28px; }

        /* TABLES & LISTS */
        .admin-card { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 30px; }
        .admin-card h3 { margin-top: 0; display: flex; justify-content: space-between; align-items: center; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th { text-align: left; background: #f8fafc; padding: 15px; color: #666; border-bottom: 2px solid #eee; }
        td { padding: 15px; border-bottom: 1px solid #eee; font-size: 15px; }
        
        .badge { padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 700; }
        .badge-pending { background: #fef3c7; color: #d97706; }
        .badge-success { background: #d1fae5; color: #059669; }
        
        /* BUTTONS */
        .btn { padding: 8px 15px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; transition: 0.3s; font-family: inherit; }
        .btn-approve { background: #d1fae5; color: #059669; margin-right: 5px; }
        .btn-reject { background: #fee2e2; color: #ef4444; }
        .btn-primary { background: var(--primary); color: white; padding: 12px 25px; }

        /* INPUTS */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #444; }
        .inp { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-family: inherit; }

        .section { display: none; animation: fadeIn 0.3s ease-in; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* MOBILE FIX */
        @media (max-width: 768px) {
            .sidebar { width: 70px; padding: 10px; }
            .sidebar h2, .nav-link span { display: none; }
            .main-content { margin-left: 70px; width: calc(100% - 70px); }
            .stats-grid { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2>Admin V</h2>
        <div class="nav-link active" onclick="showSec('dash', this)"><i class="fas fa-chart-line"></i> <span>ড্যাশবোর্ড</span></div>
        <div class="nav-link" onclick="showSec('req', this)"><i class="fas fa-bell"></i> <span>রিকোয়েস্টসমূহ</span></div>
        <div class="nav-link" onclick="showSec('users', this)"><i class="fas fa-users"></i> <span>ইউজার লিস্ট</span></div>
        <div class="nav-link" onclick="showSec('tasks', this)"><i class="fas fa-tasks"></i> <span>টাস্ক ম্যানেজমেন্ট</span></div>
        <div class="nav-link" onclick="showSec('config', this)"><i class="fas fa-cog"></i> <span>সেটিংস</span></div>
    </div>

    <div class="main-content">
        
        <div id="sec-dash" class="section active">
            <div class="stats-grid">
                <div class="stat-card"><h4>মোট ইউজার</h4><h2 id="st-users">0</h2></div>
                <div class="stat-card"><h4>মোট ব্যালেন্স</h4><h2 id="st-bal">৳0</h2></div>
                <div class="stat-card"><h4>পেন্ডিং রিকোয়েস্ট</h4><h2 id="st-req">0</h2></div>
                <div class="stat-card"><h4>আজকের ইনকাম</h4><h2 id="st-today">৳0</h2></div>
            </div>
            
            <div class="admin-card">
                <h3>সর্বশেষ ইউজারসমূহ</h3>
                <table id="recent-users-table">
                    <thead><tr><th>নাম</th><th>ফোন</th><th>ব্যালেন্স</th><th>প্ল্যান</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div id="sec-req" class="section">
            <div class="admin-card">
                <h3>পেন্ডিং রিকোয়েস্ট (Tasks, Withdraw, VIP)</h3>
                <table id="requests-table">
                    <thead><tr><th>ইউজার</th><th>ধরন</th><th>পরিমাণ</th><th>প্রুফ/TrxID</th><th>অ্যাকশন</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div id="sec-users" class="section">
            <div class="admin-card">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3>ইউজার ম্যানেজমেন্ট</h3>
                    <input type="text" id="user-search" class="inp" placeholder="নাম বা ফোন দিয়ে খুঁজুন..." style="width:250px">
                </div>
                <table id="all-users-table">
                    <thead><tr><th>ID</th><th>নাম</th><th>ফোন</th><th>ব্যালেন্স</th><th>প্ল্যান</th><th>ম্যানেজ</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div id="sec-tasks" class="section">
            <div class="admin-card">
                <h3>নতুন টাস্ক যোগ করুন</h3>
                <div class="stats-grid" style="grid-template-columns: 1fr 1fr 1fr; margin-bottom:0">
                    <input type="text" id="t-title" class="inp" placeholder="টাস্ক নাম">
                    <input type="text" id="t-link" class="inp" placeholder="টাস্ক লিংক">
                    <input type="number" id="t-reward" class="inp" placeholder="রিওয়ার্ড (৳)">
                    <select id="t-target" class="inp">
                        <option value="Free">Free Member</option>
                        <option value="Silver">Silver Member</option>
                        <option value="Gold">Gold Member</option>
                    </select>
                    <button class="btn btn-primary" onclick="addTask()">টাস্ক সেভ করুন</button>
                </div>
            </div>
            <div class="admin-card">
                <h3>বর্তমান টাস্কসমূহ</h3>
                <table id="tasks-table">
                    <thead><tr><th>নাম</th><th>টার্গেট</th><th>রিওয়ার্ড</th><th>অ্যাকশন</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div id="sec-config" class="section">
            <div class="admin-card">
                <h3>অ্যাপ কনফিগারেশন</h3>
                <div style="max-width: 500px;">
                    <div class="form-group">
                        <label>বিকাশ নাম্বার (Send Money)</label>
                        <input type="text" id="c-bkash" class="inp">
                    </div>
                    <div class="form-group">
                        <label>নগদ নাম্বার (Send Money)</label>
                        <input type="text" id="c-nagad" class="inp">
                    </div>
                    <div class="form-group">
                        <label>টেলিগ্রাম সাপোর্ট লিংক</label>
                        <input type="text" id="c-tg" class="inp">
                    </div>
                    <button class="btn btn-primary" onclick="saveConfig()">সেটিংস আপডেট করুন</button>
                </div>
            </div>
        </div>

    </div>
    <script>
        // =========================================
        // 1. FIREBASE CONFIGURATION (Must match User Panel V24.0)
        // =========================================
        const firebaseConfig = { 
            apiKey: "AIzaSyDgI-d8iwWr40tmknbY6jhH0oRb2Tvg4d0", 
            authDomain: "takar-gach-a1d84.firebaseapp.com", 
            databaseURL: "https://takar-gach-a1d84-default-rtdb.firebaseio.com", 
            projectId: "takar-gach-a1d84", 
            storageBucket: "takar-gach-a1d84.firebasestorage.app", 
            messagingSenderId: "637802367074", 
            appId: "1:637802367074:web:2e7f6c0670ec47f3a1693b" 
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // GLOBAL DATA STORE
        let ALL_USERS = {}, ALL_TASKS = {}, ALL_REQS = [], APP_CONF = {};

        // =========================================
        // 2. INITIALIZATION & REAL-TIME SYNC
        // =========================================
        window.onload = () => {
            loadDashboard();
            loadUsers();
            loadSettings();
        };

        // NAVIGATION CONTROL
        function showSec(id, el) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
            document.getElementById('sec-' + id).classList.add('active');
            el.classList.add('active');
        }

        // =========================================
        // 3. DASHBOARD & REQUEST LOGIC
        // =========================================
        function loadDashboard() {
            // Listen for all users to calculate stats
            db.ref('users').on('value', snapshot => {
                ALL_USERS = snapshot.val() || {};
                let totalBal = 0, userCount = 0, pendingCount = 0;
                ALL_REQS = [];

                Object.keys(ALL_USERS).forEach(uid => {
                    const user = ALL_USERS[uid];
                    userCount++;
                    totalBal += (parseInt(user.balance) || 0);

                    // Collect all pending history items
                    if (user.history) {
                        Object.keys(user.history).forEach(hid => {
                            const item = user.history[hid];
                            if (item.status === 'Pending') {
                                ALL_REQS.push({ ...item, uid, hid, name: user.name });
                                pendingCount++;
                            }
                        });
                    }
                });

                document.getElementById('st-users').innerText = userCount;
                document.getElementById('st-bal').innerText = '৳' + totalBal;
                document.getElementById('st-req').innerText = pendingCount;
                
                renderRecentUsers();
                renderRequests();
            });
        }

        function renderRequests() {
            const tbody = document.querySelector('#requests-table tbody');
            tbody.innerHTML = '';
            ALL_REQS.forEach(r => {
                tbody.innerHTML += `
                    <tr>
                        <td><b>${r.name}</b><br><small>${r.uid}</small></td>
                        <td><span class="badge badge-pending">${r.type}</span></td>
                        <td>৳${r.amount}</td>
                        <td><u style="cursor:pointer;color:blue" onclick="Swal.fire('Proof/TrxID','${r.proof || r.trx || 'N/A'}')">View Detail</u></td>
                        <td>
                            <button class="btn btn-approve" onclick="manageReq('${r.uid}', '${r.hid}', 'approve', '${r.type}', ${r.amount})">Approve</button>
                            <button class="btn btn-reject" onclick="manageReq('${r.uid}', '${r.hid}', 'reject')">Reject</button>
                        </td>
                    </tr>`;
            });
        }

        // APPROVE / REJECT MASTER LOGIC
        async function manageReq(uid, hid, action, type, amt) {
            if (action === 'approve') {
                const updateData = { [`users/${uid}/history/${hid}/status`]: 'Success' };
                
                // If it's a Task or Reward, add to balance
                if (type.includes('Task') || type.includes('Reward')) {
                    const currentBal = (parseInt(ALL_USERS[uid].balance) || 0);
                    updateData[`users/${uid}/balance`] = currentBal + parseInt(amt);
                }
                
                // If it's a VIP Buy, update user status
                if (type.includes('Buy')) {
                    const planName = type.replace('Buy ', '');
                    updateData[`users/${uid}/isVip`] = true;
                    updateData[`users/${uid}/currentPlan`] = planName;
                }

                await db.ref().update(updateData);
                Swal.fire('সফল!', 'রিকোয়েস্ট অ্যাপ্রুভ করা হয়েছে।', 'success');
            } else {
                // Reject with Reason
                const { value: reason } = await Swal.fire({
                    title: 'রিজেক্ট করার কারণ',
                    input: 'text',
                    inputPlaceholder: 'উদা: সঠিক নিয়মে কাজ করেননি',
                    showCancelButton: true
                });

                if (reason) {
                    await db.ref(`users/${uid}/history/${hid}`).update({
                        status: 'Rejected',
                        reason: reason
                    });
                    Swal.fire('রিজেক্টেড', 'ইউজারকে নোটিফিকেশন পাঠানো হয়েছে।', 'error');
                }
            }
        }

        // =========================================
        // 4. USER MANAGEMENT
        // =========================================
        function loadUsers() {
            const search = document.getElementById('user-search');
            search.addEventListener('input', renderUsers);
        }

        function renderUsers() {
            const tbody = document.querySelector('#all-users-table tbody');
            const term = document.getElementById('user-search').value.toLowerCase();
            tbody.innerHTML = '';

            Object.keys(ALL_USERS).forEach(uid => {
                const u = ALL_USERS[uid];
                if (u.name.toLowerCase().includes(term) || uid.includes(term)) {
                    tbody.innerHTML += `
                        <tr>
                            <td>${u.randID || 'N/A'}</td>
                            <td>${u.name}</td>
                            <td>${uid}</td>
                            <td>৳${u.balance}</td>
                            <td>${u.currentPlan || 'Free'}</td>
                            <td>
                                <button class="btn btn-approve" onclick="editUser('${uid}')"><i class="fas fa-edit"></i></button>
                            </td>
                        </tr>`;
                }
            });
        }

        async function editUser(uid) {
            const u = ALL_USERS[uid];
            const { value: formValues } = await Swal.fire({
                title: 'ইউজার ম্যানেজ করুন',
                html:
                    `<label>ব্যালেন্স সংশোধন</label><input id="sw-bal" class="swal2-input" value="${u.balance}">` +
                    `<label>প্যাকেজ পরিবর্তন</label><input id="sw-plan" class="swal2-input" value="${u.currentPlan || 'Free'}">`,
                focusConfirm: false,
                preConfirm: () => [
                    document.getElementById('sw-bal').value,
                    document.getElementById('sw-plan').value
                ]
            });

            if (formValues) {
                db.ref('users/' + uid).update({
                    balance: parseInt(formValues[0]),
                    currentPlan: formValues[1],
                    isVip: formValues[1] !== 'Free'
                });
                Swal.fire('Done!', 'ইউজার ডাটা আপডেট হয়েছে।', 'success');
            }
        }

        // =========================================
        // 5. TASK MANAGEMENT
        // =========================================
        function loadSettings() {
            db.ref('settings').on('value', s => {
                const d = s.val() || {};
                ALL_TASKS = d.tasks || {};
                APP_CONF = d.config || {};
                
                renderTasksTable();
                
                // Fill Config Fields
                document.getElementById('c-bkash').value = APP_CONF.bkash || '';
                document.getElementById('c-nagad').value = APP_CONF.nagad || '';
                document.getElementById('c-tg').value = APP_CONF.tgSupport || '';
            });
        }

        function renderTasksTable() {
            const tbody = document.querySelector('#tasks-table tbody');
            tbody.innerHTML = '';
            Object.keys(ALL_TASKS).forEach(tid => {
                const t = ALL_TASKS[tid];
                tbody.innerHTML += `
                    <tr>
                        <td>${t.title}</td>
                        <td>${t.target}</td>
                        <td>৳${t.reward}</td>
                        <td><button class="btn btn-reject" onclick="db.ref('settings/tasks/${tid}').remove()">Delete</button></td>
                    </tr>`;
            });
        }

        function addTask() {
            const title = document.getElementById('t-title').value;
            const link = document.getElementById('t-link').value;
            const reward = document.getElementById('t-reward').value;
            const target = document.getElementById('t-target').value;

            if (!title || !link || !reward) return Swal.fire('Error', 'সব তথ্য দিন', 'error');

            const tid = 'task_' + Date.now();
            db.ref('settings/tasks/' + tid).set({ title, link, reward, target });
            Swal.fire('সফল', 'নতুন টাস্ক যোগ হয়েছে।', 'success');
        }

        function saveConfig() {
            const bk = document.getElementById('c-bkash').value;
            const ng = document.getElementById('c-nagad').value;
            const tg = document.getElementById('c-tg').value;

            db.ref('settings/config').update({ bkash: bk, nagad: ng, tgSupport: tg });
            Swal.fire('সফল', 'অ্যাপ সেটিংস আপডেট হয়েছে।', 'success');
        }

        function renderRecentUsers() {
            const tbody = document.querySelector('#recent-users-table tbody');
            tbody.innerHTML = '';
            Object.keys(ALL_USERS).slice(-5).forEach(uid => {
                const u = ALL_USERS[uid];
                tbody.innerHTML += `<tr><td>${u.name}</td><td>${uid}</td><td>৳${u.balance}</td><td>${u.currentPlan || 'Free'}</td></tr>`;
            });
        }
    </script>
</body>
</html>
