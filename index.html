<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Takar Gach - Admin Pro</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Hind+Siliguri:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #10b981; --dark: #111827; --light: #f3f4f6; 
            --sidebar-w: 260px; --text: #374151; --danger: #ef4444; --warning: #f59e0b;
        }
        
        * { box-sizing: border-box; outline: none; font-family: 'Inter', 'Hind Siliguri', sans-serif; text-decoration: none; }
        body { margin: 0; background: var(--light); height: 100vh; display: flex; overflow: hidden; color: var(--text); }

        /* --- LOGIN SCREEN --- */
        #login-view {
            position: fixed; inset: 0; background: var(--dark); z-index: 9999;
            display: flex; justify-content: center; align-items: center;
        }
        .login-card {
            background: white; width: 400px; padding: 40px; border-radius: 16px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3); text-align: center;
        }
        .inp { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 15px; font-size: 15px; }
        .btn { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn:hover { opacity: 0.9; }

        /* --- DASHBOARD LAYOUT --- */
        .sidebar {
            width: var(--sidebar-w); background: var(--dark); color: white;
            display: flex; flex-direction: column; transition: 0.3s;
        }
        .brand { height: 70px; display: flex; align-items: center; padding: 0 20px; font-size: 20px; font-weight: 800; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .menu { flex: 1; padding: 20px 10px; overflow-y: auto; }
        .menu-item {
            padding: 12px 15px; margin-bottom: 5px; border-radius: 10px; cursor: pointer;
            display: flex; align-items: center; gap: 12px; color: #9ca3af; transition: 0.2s; font-size: 14px;
        }
        .menu-item:hover, .menu-item.active { background: var(--primary); color: white; }
        .menu-item i { width: 20px; text-align: center; }

        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .top-bar {
            height: 70px; background: white; border-bottom: 1px solid #e5e7eb;
            display: flex; align-items: center; justify-content: space-between; padding: 0 30px;
        }
        .content-body { flex: 1; padding: 30px; overflow-y: auto; }

        /* --- COMPONENTS --- */
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .grid-4 { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        
        .stat-box { display: flex; align-items: center; justify-content: space-between; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-left: 5px solid var(--primary); }
        .stat-box h2 { margin: 0; font-size: 28px; }
        .stat-box p { margin: 5px 0 0; color: #6b7280; font-size: 13px; }
        
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #f3f4f6; }
        th { background: #f9fafb; font-weight: 600; color: #6b7280; text-transform: uppercase; font-size: 12px; }
        
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: bold; }
        .badge-success { background: #d1fae5; color: #059669; }
        .badge-warning { background: #fef3c7; color: #d97706; }
        .badge-danger { background: #fee2e2; color: #dc2626; }

        .btn-sm { padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; border: none; color: white; margin-right: 5px; }
        .btn-green { background: var(--primary); }
        .btn-red { background: var(--danger); }
        .btn-blue { background: #3b82f6; }

        /* --- MODAL --- */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .modal-content { background: white; width: 450px; padding: 30px; border-radius: 16px; animation: slideIn 0.3s; }
        @keyframes slideIn { from{transform:translateY(-20px);opacity:0} to{transform:translateY(0);opacity:1} }
    </style>
</head>
<body>

    <div id="login-view">
        <div class="login-card">
            <i class="fas fa-user-shield" style="font-size:50px; color:var(--primary); margin-bottom:20px"></i>
            <h2>Admin Login</h2>
            <p>সিকিউরিটি প্যানেলে আপনাকে স্বাগতম</p>
            <input id="adm-usr" class="inp" placeholder="Username" value="JIHAD">
            <input id="adm-pass" type="password" class="inp" placeholder="Password">
            <button class="btn" onclick="authAdmin()">লগইন করুন</button>
        </div>
    </div>

    <div id="dashboard-view" style="display:none; width:100%">
        <div class="sidebar">
            <div class="brand"><i class="fas fa-tree" style="margin-right:10px; color:var(--primary)"></i> টাকার গাছ</div>
            <div class="menu">
                <div class="menu-item active" onclick="nav('dash',this)"><i class="fas fa-th-large"></i> ড্যাশবোর্ড</div>
                <div class="menu-item" onclick="nav('users',this)"><i class="fas fa-users"></i> সকল ইউজার</div>
                <div class="menu-item" onclick="nav('deposits',this)"><i class="fas fa-money-bill-wave"></i> ডিপোজিট রিকোয়েস্ট</div>
                <div class="menu-item" onclick="nav('withdraws',this)"><i class="fas fa-wallet"></i> উইথড্র রিকোয়েস্ট</div>
                <div class="menu-item" onclick="nav('tasks',this)"><i class="fas fa-check-circle"></i> টাস্ক ম্যানেজমেন্ট</div>
                <div class="menu-item" onclick="nav('settings',this)"><i class="fas fa-cogs"></i> সেটিংস</div>
            </div>
            <div style="padding:20px; border-top:1px solid rgba(255,255,255,0.1)">
                <button class="btn" style="background:rgba(255,255,255,0.1); font-size:12px" onclick="logout()">লগ আউট</button>
            </div>
        </div>

        <div class="main-content">
            <div class="top-bar">
                <h3 id="page-title">ড্যাশবোর্ড</h3>
                <div style="display:flex; align-items:center; gap:10px">
                    <span class="badge badge-success">Admin</span>
                    <i class="fas fa-user-circle" style="font-size:30px; color:#374151"></i>
                </div>
            </div>
            <div class="content-body" id="main-body">
                </div>
        </div>
    </div>

    <div id="edit-modal" class="modal"><div class="modal-content">
        <h3>ইউজার এডিট</h3>
        <input type="hidden" id="e-uid">
        <label>ব্যালেন্স সেট করুন:</label>
        <input id="e-bal" type="number" class="inp" placeholder="Amount">
        <label>পাসওয়ার্ড চেঞ্জ:</label>
        <input id="e-pass" type="text" class="inp" placeholder="New Password">
        <button class="btn" onclick="saveUserEdit()">সেভ করুন</button>
        <button class="btn" style="background:#ddd; color:black; margin-top:10px" onclick="document.getElementById('edit-modal').style.display='none'">বন্ধ করুন</button>
    </div></div>

    <script>
        // --- CONFIG ---
        const firebaseConfig = { apiKey: "AIzaSyDgI-d8iwWr40tmknbY6jhH0oRb2Tvg4d0", authDomain: "takar-gach-a1d84.firebaseapp.com", databaseURL: "https://takar-gach-a1d84-default-rtdb.firebaseio.com", projectId: "takar-gach-a1d84", storageBucket: "takar-gach-a1d84.firebasestorage.app", messagingSenderId: "637802367074", appId: "1:637802367074:web:2e7f6c0670ec47f3a1693b", measurementId: "G-0QL9LB7BSK" };
        firebase.initializeApp(firebaseConfig); const db = firebase.database();

        // --- AUTH ---
        const CRED = { u: 'JIHAD', p: '198373' };

        function authAdmin(){
            const u = document.getElementById('adm-usr').value;
            const p = document.getElementById('adm-pass').value;
            
            if(p.length < 6) return Swal.fire('Error', 'পাসওয়ার্ড মিনিমাম ৬ সংখ্যার হতে হবে', 'error');
            
            if(u === CRED.u && p === CRED.p){
                sessionStorage.setItem('adm_ok', 'true');
                initDash();
            } else {
                Swal.fire('Access Denied', 'ভুল তথ্য দিয়েছেন', 'error');
            }
        }

        function initDash(){
            document.getElementById('login-view').style.display = 'none';
            document.getElementById('dashboard-view').style.display = 'flex';
            loadPage('dash');
        }

        function logout(){ sessionStorage.clear(); location.reload(); }
        window.onload = () => { if(sessionStorage.getItem('adm_ok')) initDash(); }

        // --- NAVIGATION ---
        function nav(page, el){
            document.querySelectorAll('.menu-item').forEach(i=>i.classList.remove('active'));
            if(el) el.classList.add('active');
            loadPage(page);
        }

        function loadPage(page){
            const c = document.getElementById('main-body');
            c.innerHTML = '<div style="text-align:center;padding:50px"><i class="fas fa-spinner fa-spin fa-2x"></i> Loading...</div>';
            
            if(page === 'dash') loadDashboard(c);
            else if(page === 'users') loadUsers(c);
            else if(page === 'deposits') loadTransactions(c, 'Buy');
            else if(page === 'withdraws') loadTransactions(c, 'Withdraw');
            else if(page === 'tasks') loadTasks(c);
            else if(page === 'settings') loadSettings(c);
        }

        // --- PAGES LOGIC ---
        
        function loadDashboard(c){
            document.getElementById('page-title').innerText = 'ড্যাশবোর্ড';
            db.ref('users').once('value', s=>{
                const u = s.val() || {};
                let totalUser = Object.keys(u).length;
                let totalBal = 0;
                let pendingDep = 0;
                let pendingWd = 0;

                Object.values(u).forEach(user => {
                    totalBal += (user.balance || 0);
                    if(user.history){
                        Object.values(user.history).forEach(h => {
                            if(h.status === 'Pending'){
                                if(h.type === 'Withdraw') pendingWd++;
                                else pendingDep++;
                            }
                        });
                    }
                });

                c.innerHTML = `
                    <div class="grid-4">
                        <div class="stat-box" style="border-color:#3b82f6"><div><h2>${totalUser}</h2><p>মোট ইউজার</p></div><i class="fas fa-users fa-2x" style="color:#3b82f6"></i></div>
                        <div class="stat-box" style="border-color:#10b981"><div><h2>৳${totalBal}</h2><p>ইউজার ব্যালেন্স</p></div><i class="fas fa-wallet fa-2x" style="color:#10b981"></i></div>
                        <div class="stat-box" style="border-color:#f59e0b"><div><h2>${pendingDep}</h2><p>পেন্ডিং ডিপোজিট</p></div><i class="fas fa-arrow-down fa-2x" style="color:#f59e0b"></i></div>
                        <div class="stat-box" style="border-color:#ef4444"><div><h2>${pendingWd}</h2><p>পেন্ডিং উইথড্র</p></div><i class="fas fa-arrow-up fa-2x" style="color:#ef4444"></i></div>
                    </div>
                    <div class="card">
                        <h3>সাম্প্রতিক জয়েনিং</h3>
                        <table>
                            <thead><tr><th>নাম</th><th>ফোন</th><th>জয়েন তারিখ</th><th>ব্যালেন্স</th></tr></thead>
                            <tbody>
                                ${Object.values(u).slice(-5).reverse().map(x=>`<tr><td>${x.name}</td><td>${x.phone}</td><td>${x.join||'-'}</td><td>৳${x.balance}</td></tr>`).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            });
        }

        function loadUsers(c){
            document.getElementById('page-title').innerText = 'সকল ইউজার';
            db.ref('users').once('value', s=>{
                const users = s.val() || {};
                let html = `
                    <div class="card">
                        <input onkeyup="searchTbl(this)" class="inp" placeholder="Search by Phone..." style="max-width:300px">
                        <table>
                            <thead><tr><th>নাম</th><th>ফোন</th><th>ব্যালেন্স</th><th>পাসওয়ার্ড</th><th>অ্যাকশন</th></tr></thead>
                            <tbody id="tbl-body">
                `;
                Object.keys(users).forEach(k=>{
                    const u = users[k];
                    html += `<tr>
                        <td>${u.name} <br> <small style="color:#aaa">UID: ${u.uid}</small></td>
                        <td>${u.phone}</td>
                        <td>৳${u.balance}</td>
                        <td>${u.pass}</td>
                        <td>
                            <button class="btn-sm btn-blue" onclick="editUser('${k}')"><i class="fas fa-edit"></i></button>
                            <button class="btn-sm btn-red" onclick="delUser('${k}')"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
                });
                html += '</tbody></table></div>';
                c.innerHTML = html;
            });
        }

        function loadTransactions(c, type){
            document.getElementById('page-title').innerText = type === 'Buy' ? 'ডিপোজিট রিকোয়েস্ট' : 'উইথড্র রিকোয়েস্ট';
            db.ref('users').once('value', s=>{
                const users = s.val() || {};
                let html = `<div class="card"><table><thead><tr><th>ইউজার</th><th>পরিমাণ</th><th>মেথড</th><th>TrxID/Num</th><th>অ্যাকশন</th></tr></thead><tbody>`;
                let hasData = false;

                Object.keys(users).forEach(uid => {
                    const h = users[uid].history || {};
                    Object.keys(h).forEach(hid => {
                        const txn = h[hid];
                        if(txn.status === 'Pending' && (
                            (type === 'Buy' && txn.type.includes('Buy')) || 
                            (type === 'Withdraw' && txn.type === 'Withdraw')
                        )) {
                            hasData = true;
                            html += `<tr>
                                <td>${users[uid].name}<br><small>${users[uid].phone}</small></td>
                                <td><b>৳${txn.amount}</b><br><small>${txn.type}</small></td>
                                <td>${txn.method}</td>
                                <td>${txn.trx || txn.sender || txn.method}</td>
                                <td>
                                    <button class="btn-sm btn-green" onclick="handleTx('${uid}','${hid}','Success','${txn.type}',${txn.amount})">Approve</button>
                                    <button class="btn-sm btn-red" onclick="handleTx('${uid}','${hid}','Rejected','${txn.type}',${txn.amount})">Reject</button>
                                </td>
                            </tr>`;
                        }
                    });
                });
                html += '</tbody></table></div>';
                if(!hasData) html = '<div class="card" style="text-align:center">কোনো পেন্ডিং রিকোয়েস্ট নেই</div>';
                c.innerHTML = html;
            });
        }

        function handleTx(uid, hid, status, type, amount){
            db.ref(`users/${uid}/history/${hid}`).update({status: status});
            
            if(status === 'Success' && type.includes('Buy')){
                // Activate VIP
                const plan = type.replace('Buy ', '');
                db.ref(`users/${uid}`).update({ isVip: true, currentPlan: plan, vipExpire: Date.now() + (30*86400000) });
            } 
            else if(status === 'Rejected' && type === 'Withdraw'){
                // Refund Balance
                db.ref(`users/${uid}/balance`).transaction(b => (b||0) + parseInt(amount));
            }
            
            Swal.fire('Done', 'স্ট্যাটাস আপডেট করা হয়েছে', 'success');
            loadTransactions(document.getElementById('main-body'), type.includes('Buy')?'Buy':'Withdraw');
        }

        function loadTasks(c){
            document.getElementById('page-title').innerText = 'টাস্ক ম্যানেজমেন্ট';
            c.innerHTML = `
                <div class="card">
                    <h3>নতুন টাস্ক</h3>
                    <div style="display:flex; gap:10px">
                        <input id="t-tt" class="inp" placeholder="Title">
                        <input id="t-rw" class="inp" type="number" placeholder="Reward">
                        <input id="t-ln" class="inp" placeholder="Link">
                        <select id="t-ty" class="inp"><option value="free">Free</option><option value="vip">VIP</option></select>
                        <button class="btn" style="width:150px" onclick="addTask()">Add</button>
                    </div>
                </div>
                <div class="card" id="task-list-view"></div>
            `;
            db.ref('settings/tasks').on('value', s=>{
                const t = s.val()||{};
                let html = '<table><thead><tr><th>টাইটেল</th><th>রিওয়ার্ড</th><th>টাইপ</th><th>একশন</th></tr></thead><tbody>';
                Object.keys(t).forEach(k=>{
                    html += `<tr><td>${t[k].title}</td><td>৳${t[k].reward}</td><td>${t[k].target}</td><td><button class="btn-sm btn-red" onclick="delTask('${k}')">Del</button></td></tr>`;
                });
                document.getElementById('task-list-view').innerHTML = html + '</tbody></table>';
            });
        }

        function addTask(){
            const d = {
                title: document.getElementById('t-tt').value,
                reward: parseInt(document.getElementById('t-rw').value),
                link: document.getElementById('t-ln').value,
                target: document.getElementById('t-ty').value
            };
            if(!d.title) return Swal.fire('Error','Fill all','error');
            db.ref('settings/tasks').push(d);
            Swal.fire('Added','Task Added','success');
        }
        function delTask(k){ db.ref('settings/tasks/'+k).remove(); }

        function loadSettings(c){
            document.getElementById('page-title').innerText = 'সেটিংস';
            db.ref('settings/config').once('value', s=>{
                const conf = s.val()||{};
                c.innerHTML = `
                    <div class="card" style="max-width:500px">
                        <h3>পেমেন্ট নাম্বার</h3>
                        <label>বিকাশ নাম্বার</label>
                        <input id="s-bk" class="inp" value="${conf.bkash||''}">
                        <label>নগদ নাম্বার</label>
                        <input id="s-ng" class="inp" value="${conf.nagad||''}">
                        <button class="btn" onclick="saveConf()">সেভ করুন</button>
                    </div>
                `;
            });
        }
        function saveConf(){
            db.ref('settings/config').update({
                bkash: document.getElementById('s-bk').value,
                nagad: document.getElementById('s-ng').value
            });
            Swal.fire('Saved');
        }

        // --- USER ACTIONS ---
        function editUser(uid){
            db.ref('users/'+uid).once('value', s=>{
                const u = s.val();
                document.getElementById('e-uid').value = uid;
                document.getElementById('e-bal').value = u.balance;
                document.getElementById('e-pass').value = u.pass;
                document.getElementById('edit-modal').style.display = 'flex';
            });
        }
        function saveUserEdit(){
            const uid = document.getElementById('e-uid').value;
            const bal = parseInt(document.getElementById('e-bal').value);
            const pass = document.getElementById('e-pass').value;
            db.ref('users/'+uid).update({balance:bal, pass:pass});
            document.getElementById('edit-modal').style.display='none';
            Swal.fire('Success','Updated','success');
            loadUsers(document.getElementById('main-body'));
        }
        function delUser(uid){
            if(confirm('Are you sure?')){
                db.ref('users/'+uid).remove();
                loadUsers(document.getElementById('main-body'));
            }
        }

        function searchTbl(el){
            const v = el.value.toLowerCase();
            document.querySelectorAll('#tbl-body tr').forEach(r=>{
                r.style.display = r.innerText.toLowerCase().includes(v) ? '' : 'none';
            });
        }
    </script>
</body>
</html>

