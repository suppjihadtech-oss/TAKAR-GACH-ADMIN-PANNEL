<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Takar Gach</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Hind+Siliguri:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #10b981; --dark: #1f2937; --light: #f3f4f6; --white: #ffffff;
            --sidebar-w: 260px; --header-h: 70px;
        }
        * { box-sizing: border-box; outline: none; text-decoration: none; }
        body { margin: 0; background: var(--light); font-family: 'Inter', 'Hind Siliguri', sans-serif; height: 100vh; display: flex; overflow: hidden; }

        /* --- AUTH SCREEN --- */
        #auth-view { position: fixed; inset: 0; background: var(--dark); z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .login-box { background: var(--white); padding: 40px; border-radius: 20px; width: 400px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
        .inp { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .btn { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }

        /* --- SIDEBAR --- */
        .sidebar { width: var(--sidebar-w); background: var(--dark); color: white; display: flex; flex-direction: column; transition: 0.3s; }
        .brand { height: var(--header-h); display: flex; align-items: center; padding: 0 20px; font-size: 20px; font-weight: bold; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .menu { flex: 1; padding: 20px 10px; overflow-y: auto; }
        .menu-item { padding: 12px 15px; margin-bottom: 5px; border-radius: 10px; cursor: pointer; display: flex; align-items: center; gap: 10px; color: #9ca3af; transition: 0.2s; }
        .menu-item:hover, .menu-item.active { background: var(--primary); color: white; }
        
        /* --- MAIN CONTENT --- */
        .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .header { height: var(--header-h); background: var(--white); display: flex; align-items: center; justify-content: space-between; padding: 0 30px; border-bottom: 1px solid #e5e7eb; }
        .content { flex: 1; padding: 30px; overflow-y: auto; }

        /* --- CARDS & TABLES --- */
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--white); padding: 25px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
        .stat-card h3 { margin: 0; font-size: 28px; }
        .stat-card p { margin: 5px 0 0; color: #6b7280; font-size: 14px; }
        
        .card { background: var(--white); border-radius: 15px; padding: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #f3f4f6; }
        th { font-size: 12px; color: #6b7280; text-transform: uppercase; background: #f9fafb; }
        
        /* --- UTILS --- */
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: bold; }
        .badge-pending { background: #fef3c7; color: #d97706; }
        .badge-success { background: #d1fae5; color: #059669; }
        .btn-sm { padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; border: none; color: white; margin-right: 5px; }
        .btn-approve { background: var(--primary); }
        .btn-reject { background: #ef4444; }
        .btn-del { background: #ef4444; }

        /* --- MODAL --- */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; width: 400px; animation: slideDown 0.3s; }
        @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body>

    <div id="auth-view">
        <div class="login-box">
            <h2 style="margin-bottom: 20px;">Admin Login</h2>
            <input id="a-user" class="inp" placeholder="Username">
            <input id="a-pass" type="password" class="inp" placeholder="Password">
            <button class="btn" onclick="doLogin()">Login</button>
        </div>
    </div>

    <div id="dashboard" style="display:none; width:100%">
        <div class="sidebar">
            <div class="brand"><i class="fas fa-tree" style="margin-right:10px"></i> Admin Pro</div>
            <div class="menu">
                <div class="menu-item active" onclick="nav('dash',this)"><i class="fas fa-home"></i> Dashboard</div>
                <div class="menu-item" onclick="nav('users',this)"><i class="fas fa-users"></i> Users</div>
                <div class="menu-item" onclick="nav('deposits',this)"><i class="fas fa-money-bill-wave"></i> Deposits <span id="dep-c" class="badge badge-pending" style="margin-left:auto">0</span></div>
                <div class="menu-item" onclick="nav('withdraws',this)"><i class="fas fa-wallet"></i> Withdraws <span id="wd-c" class="badge badge-pending" style="margin-left:auto">0</span></div>
                <div class="menu-item" onclick="nav('tasks',this)"><i class="fas fa-tasks"></i> Tasks</div>
                <div class="menu-item" onclick="nav('settings',this)"><i class="fas fa-cogs"></i> Settings</div>
            </div>
        </div>

        <div class="main">
            <div class="header">
                <h3>Dashboard Overview</h3>
                <button class="btn-sm" style="background:#374151" onclick="logout()">Logout</button>
            </div>
            <div class="content" id="main-body"></div>
        </div>
    </div>

    <script>
        // CONFIG (SAME AS USER APP)
        const firebaseConfig = { apiKey: "AIzaSyDgI-d8iwWr40tmknbY6jhH0oRb2Tvg4d0", authDomain: "takar-gach-a1d84.firebaseapp.com", databaseURL: "https://takar-gach-a1d84-default-rtdb.firebaseio.com", projectId: "takar-gach-a1d84", storageBucket: "takar-gach-a1d84.firebasestorage.app", messagingSenderId: "637802367074", appId: "1:637802367074:web:2e7f6c0670ec47f3a1693b", measurementId: "G-0QL9LB7BSK" };
        firebase.initializeApp(firebaseConfig); const db = firebase.database();

        // ADMIN CREDENTIALS
        const ADM_USER = "admin";
        const ADM_PASS = "123456";

        window.onload = () => { if(sessionStorage.getItem('adm_log')) showDash(); };

        function doLogin(){
            const u = document.getElementById('a-user').value;
            const p = document.getElementById('a-pass').value;
            if(u===ADM_USER && p===ADM_PASS){
                sessionStorage.setItem('adm_log', true);
                showDash();
            } else { Swal.fire('Error','Invalid Credentials','error'); }
        }
        function logout(){ sessionStorage.removeItem('adm_log'); location.reload(); }
        function showDash(){ document.getElementById('auth-view').style.display='none'; document.getElementById('dashboard').style.display='flex'; loadPage('dash'); countPending(); }

        function nav(p,el){
            document.querySelectorAll('.menu-item').forEach(i=>i.classList.remove('active'));
            if(el) el.classList.add('active');
            loadPage(p);
        }

        function loadPage(page){
            const body = document.getElementById('main-body');
            body.innerHTML = '<div style="text-align:center;padding:50px"><i class="fas fa-spinner fa-spin fa-2x"></i></div>';

            if(page === 'dash'){
                db.ref('users').once('value', s=>{
                    const u = s.val()||{};
                    const total = Object.keys(u).length;
                    let bal = 0; Object.values(u).forEach(x=>bal+=(x.balance||0));
                    
                    body.innerHTML = `
                        <div class="grid-4">
                            <div class="stat-card"><div><h3>${total}</h3><p>Total Users</p></div><i class="fas fa-users fa-2x" style="color:#3b82f6"></i></div>
                            <div class="stat-card"><div><h3>৳${bal}</h3><p>User Balance</p></div><i class="fas fa-wallet fa-2x" style="color:#10b981"></i></div>
                        </div>
                        <div class="card">
                            <h3>Recent Users</h3>
                            <table>
                                <thead><tr><th>Name</th><th>Phone</th><th>Balance</th><th>Joined</th></tr></thead>
                                <tbody>${Object.values(u).slice(-5).reverse().map(x=>`<tr><td>${x.name}</td><td>${x.phone}</td><td>৳${x.balance}</td><td>${x.join||'-'}</td></tr>`).join('')}</tbody>
                            </table>
                        </div>
                    `;
                });
            }
            else if(page === 'users'){
                db.ref('users').once('value', s=>{
                    const u = s.val()||{};
                    body.innerHTML = `
                        <div class="card">
                            <h3>All Users</h3>
                            <input onkeyup="filterTbl(this)" placeholder="Search Phone..." class="inp" style="max-width:300px">
                            <table>
                                <thead><tr><th>Name</th><th>Phone</th><th>Balance</th><th>Plan</th><th>Action</th></tr></thead>
                                <tbody id="u-list">${Object.keys(u).map(k=>`<tr><td>${u[k].name}</td><td>${u[k].phone}</td><td>৳${u[k].balance}</td><td>${u[k].isVip?u[k].currentPlan:'Free'}</td><td><button class="btn-sm btn-del" onclick="delUser('${k}')">Del</button></td></tr>`).join('')}</tbody>
                            </table>
                        </div>
                    `;
                });
            }
            else if(page === 'deposits' || page === 'withdraws'){
                const type = page==='deposits' ? 'Buy' : 'Withdraw';
                db.ref('users').once('value', s=>{
                    const u = s.val()||{};
                    let rows = '';
                    Object.keys(u).forEach(uid=>{
                        const h = u[uid].history||{};
                        Object.keys(h).forEach(hid=>{
                            const t = h[hid];
                            if(t.status==='Pending' && ((type==='Buy' && t.type.includes('Buy')) || (type==='Withdraw' && t.type==='Withdraw'))){
                                rows += `<tr>
                                    <td>${u[uid].name}<br><small>${u[uid].phone}</small></td>
                                    <td>${t.type}</td>
                                    <td><b>৳${t.amount}</b></td>
                                    <td>${t.trx || t.sender || t.method}</td>
                                    <td>
                                        <button class="btn-sm btn-approve" onclick="actionTx('${uid}','${hid}','Success','${t.type}','${t.amount}')">Approve</button>
                                        <button class="btn-sm btn-reject" onclick="actionTx('${uid}','${hid}','Rejected','${t.type}','${t.amount}')">Reject</button>
                                    </td>
                                </tr>`;
                            }
                        });
                    });
                    body.innerHTML = `<div class="card"><h3>Pending ${page}</h3><table><thead><tr><th>User</th><th>Type</th><th>Amount</th><th>Info</th><th>Action</th></tr></thead><tbody>${rows||'<tr><td colspan="5" style="text-align:center">No Pending Request</td></tr>'}</tbody></table></div>`;
                });
            }
            else if(page === 'tasks'){
                body.innerHTML = `
                    <div class="card">
                        <h3>Add Task</h3>
                        <input id="t-ti" class="inp" placeholder="Title">
                        <input id="t-rw" class="inp" type="number" placeholder="Reward">
                        <input id="t-ln" class="inp" placeholder="Link">
                        <select id="t-ty" class="inp"><option value="free">Free</option><option value="vip">VIP</option></select>
                        <button class="btn" style="width:auto" onclick="addTask()">Add Task</button>
                    </div>
                    <div class="card">
                        <h3>Task List</h3>
                        <table><thead><tr><th>Title</th><th>Reward</th><th>Type</th><th>Action</th></tr></thead><tbody id="t-list"></tbody></table>
                    </div>
                `;
                db.ref('settings/tasks').on('value', s=>{
                    const t = s.val()||{};
                    document.getElementById('t-list').innerHTML = Object.keys(t).map(k=>`<tr><td>${t[k].title}</td><td>৳${t[k].reward}</td><td>${t[k].target}</td><td><button class="btn-sm btn-del" onclick="delTask('${k}')">Del</button></td></tr>`).join('');
                });
            }
            else if(page === 'settings'){
                db.ref('settings/config').once('value', s=>{
                    const c = s.val()||{};
                    body.innerHTML = `
                        <div class="card">
                            <h3>Payment Numbers</h3>
                            <label>Bkash:</label><input id="s-bk" class="inp" value="${c.bkash||''}">
                            <label>Nagad:</label><input id="s-ng" class="inp" value="${c.nagad||''}">
                            <button class="btn" onclick="saveSet()">Save</button>
                        </div>
                    `;
                });
            }
        }

        // --- ACTIONS ---
        function actionTx(uid, hid, st, type, amt){
            db.ref(`users/${uid}/history/${hid}`).update({status:st});
            if(st==='Success' && type.includes('Buy')){
                const plan = type.replace('Buy ','');
                db.ref(`users/${uid}`).update({isVip:true, currentPlan:plan, vipExpire:Date.now()+(30*24*60*60*1000)});
            } else if(st==='Rejected' && type==='Withdraw'){
                db.ref(`users/${uid}/balance`).transaction(b=>(b||0)+parseInt(amt));
            }
            Swal.fire('Done','Transaction Updated','success');
            loadPage(type==='Withdraw'?'withdraws':'deposits');
            countPending();
        }

        function addTask(){
            const t = {
                title: document.getElementById('t-ti').value,
                reward: parseInt(document.getElementById('t-rw').value),
                link: document.getElementById('t-ln').value,
                target: document.getElementById('t-ty').value
            };
            if(!t.title) return;
            db.ref('settings/tasks').push(t);
            Swal.fire('Added');
        }
        function delTask(k){ db.ref('settings/tasks/'+k).remove(); }

        function saveSet(){
            db.ref('settings/config').update({
                bkash: document.getElementById('s-bk').value,
                nagad: document.getElementById('s-ng').value
            });
            Swal.fire('Saved');
        }

        function delUser(k){
            if(confirm('Delete User?')) {
                db.ref('users/'+k).remove();
                loadPage('users');
            }
        }

        function countPending(){
            db.ref('users').once('value', s=>{
                const u = s.val()||{};
                let d=0, w=0;
                Object.values(u).forEach(x=>{
                    if(x.history) Object.values(x.history).forEach(h=>{
                        if(h.status==='Pending'){
                            if(h.type==='Withdraw') w++; else d++;
                        }
                    });
                });
                document.getElementById('dep-c').innerText = d;
                document.getElementById('wd-c').innerText = w;
            });
        }

        function filterTbl(e){
            const q = e.value.toLowerCase();
            document.querySelectorAll('#u-list tr').forEach(r=>{
                r.style.display = r.innerText.toLowerCase().includes(q) ? '' : 'none';
            });
        }
    </script>
</body>
</html>

